# Base ModSecurity Configuration
Include /etc/nginx/modsecurity.d/modsecurity.conf

# Basic CRS Configuration
Include /etc/modsecurity/crs/crs-setup.conf

# Main CRS Rules (prevents common attacks)
Include /usr/share/modsecurity-crs/rules/REQUEST-901-INITIALIZATION.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-905-COMMON-EXCEPTIONS.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-910-IP-REPUTATION.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-913-SCANNER-DETECTION.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf
Include /usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf

# === Anti-scanner Rules ===
SecRule REQUEST_HEADERS:User-Agent "@rx .*scanner.*" \
    "id:1000,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Scanner detected',\
    severity:'CRITICAL',\
    tag:'scanner-detection'"

SecRule REQUEST_HEADERS:User-Agent "@pm bot crawler spider" \
    "id:1001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Bot/Crawler detected',\
    severity:'WARNING',\
    tag:'automation-detection'"

# === File Upload Protection Rules ===

# Basic file upload detection (detects any file upload)
SecRule FILES "@rx ." \
    "id:1100,\
    phase:2,\
    pass,\
    log,\
    msg:'File upload detected',\
    logdata:'File=%{FILES:name}'"

# Image file check (only allow PNG, JPEG, and GIF) - magic bytes check
SecRule REQUEST_URI "@beginsWith /api/profile/" \
    "id:1101,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Invalid image file',\
    chain"
    SecRule FILES "@rx ." \
        "chain"
        SecRule FILES_TMP_CONTENT "!@rx ^(?:\x89PNG\r\n\x1a\n|\xff\xd8\xff|\x47\x49\x46\x38(?:39|37)\x61)" \
            "t:none,\
            ctl:forceRequestBodyVariable=On"

# Mixed magic numbers check (JPEG + PNG)
SecRule FILES_TMP_CONTENT "@rx (?s)^\xFF\xD8\xFF.*\x89PNG\r\n\x1A\n" \
    "id:1200,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Mixed magic numbers detected (JPEG + PNG)',\
    tag:'mixed_magic_numbers',\
    severity:'CRITICAL',\
    chain"
    SecRule REQUEST_URI "@beginsWith /api/profile/" \
        "ctl:forceRequestBodyVariable=On"

# File size check (10MB limit)
SecRule REQUEST_HEADERS:Content-Length "@gt 10000000" \
    "id:1102,\
    phase:1,\
    deny,\
    status:413,\
    log,\
    msg:'File too large',\
    tag:'file-upload'"

# File name security
SecRule FILES_NAMES "@rx (?:\.\.|\/|\\|:|\.(?:php|exe|sh|jsp|aspx|bat|cmd|py|rb|pl|cgi)$)" \
    "id:1103,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Malicious file name detected',\
    tag:'file-upload'"

# Debug logging
SecRule FILES "@rx ." \
    "id:1199,\
    phase:2,\
    pass,\
    log,\
    msg:'File upload debug',\
    logdata:'Name=%{FILES:name}, Type=%{REQUEST_HEADERS.Content-Type}'"


